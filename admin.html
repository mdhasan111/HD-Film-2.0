<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary-color: #e50914; --secondary-color: #2c3e50; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f4f6f9; color: #333; }
        .admin-header { background-color: #1a1a1a; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .admin-logo { font-size: 24px; font-weight: bold; color: var(--primary-color); }
        .admin-actions { display: flex; align-items: center; gap: 15px; }
        .admin-container { display: flex; min-height: calc(100vh - 60px); }
        .admin-sidebar { width: 250px; background-color: var(--secondary-color); color: #fff; padding: 20px 0; transition: width 0.3s; }
        .admin-main { flex: 1; padding: 20px; overflow-x: auto; }
        .sidebar-menu { list-style: none; }
        .menu-item { padding: 15px 20px; cursor: pointer; transition: background-color 0.3s; display: flex; align-items: center; gap: 10px; }
        .menu-item:hover, .menu-item.active { background-color: #34495e; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; }
        .card-title { font-size: 16px; color: #7f8c8d; margin-bottom: 10px; }
        .card-value { font-size: 24px; font-weight: bold; color: var(--secondary-color); }
        .form-section { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
        .form-title { font-size: 18px; margin-bottom: 20px; color: var(--secondary-color); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background-color: #c40812; }
        .btn-secondary { background-color: #7f8c8d; color: #fff; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .data-table th { background-color: #f8f9fa; font-weight: 600; }
        .data-table tr:hover { background-color: #f1f1f1; }
        .action-btn { padding: 5px 10px; margin-right: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; color: #fff; }
        .edit-btn { background-color: #3498db; }
        .delete-btn { background-color: #e74c3c; }
        .manage-btn { background-color: #2ecc71; }
        .episode-management-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        #backToSeriesBtn { font-size: 20px; cursor: pointer; }
        .season-container { margin-bottom: 20px; }
        .episode-card { background: #f9f9f9; border: 1px solid #eee; border-radius: 5px; padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="admin-logo">অ্যাডমিন প্যানেল</div>
        <div class="admin-actions">
            <button id="backToUser" class="btn btn-secondary">ইউজার প্যানেল</button>
            <button id="adminLogout" class="btn btn-secondary">লগআউট</button>
        </div>
    </header>
    
    <div class="admin-container">
        <aside class="admin-sidebar">
            <ul class="sidebar-menu">
                <li class="menu-item active" data-target="dashboardSection"><i class="fas fa-tachometer-alt"></i> ড্যাশবোর্ড</li>
                <li class="menu-item" data-target="movieManagementSection"><i class="fas fa-film"></i> মুভি ম্যানেজমেন্ট</li>
                <li class="menu-item" data-target="seriesManagementSection"><i class="fas fa-tv"></i> সিরিজ ম্যানেজমেন্ট</li>
                <li class="menu-item" data-target="subscriptionSection"><i class="fas fa-star"></i> সাবস্ক্রিপশন</li>
                <li class="menu-item" data-target="adManagementSection"><i class="fas fa-ad"></i> বিজ্ঞাপন ম্যানেজমেন্ট</li>
                <li class="menu-item" data-target="settingsSection"><i class="fas fa-cog"></i> সেটিংস</li>
            </ul>
        </aside>
        
        <main class="admin-main">
            <!-- Sections: Dashboard, Movie, Series -->
            <section id="dashboardSection">
                <h2 class="form-title">ড্যাশবোর্ড ওভারভিউ</h2>
                <div class="dashboard-cards">
                    <div class="card"><div class="card-title">মোট ইউজার</div><div class="card-value" id="totalUsers">0</div></div>
                    <div class="card"><div class="card-title">মোট মুভি</div><div class="card-value" id="totalMovies">0</div></div>
                    <div class="card"><div class="card-title">মোট সিরিজ</div><div class="card-value" id="totalSeries">0</div></div>
                    <div class="card"><div class="card-title">সক্রিয় সাবস্ক্রিপশন</div><div class="card-value" id="activeSubscriptions">0</div></div>
                </div>
                <div class="form-section">
                    <h3 class="form-title">সাম্প্রতিক এক্টিভিটি</h3>
                    <table class="data-table">
                        <thead><tr><th>সময়</th><th>বিষয়বস্তু</th><th>কর্ম</th></tr></thead>
                        <tbody id="activityTable"></tbody>
                    </table>
                </div>
            </section>
            
            <section id="movieManagementSection" style="display: none;">
                <div class="form-section">
                    <h3 class="form-title">TMDB থেকে তথ্য আনুন</h3>
                    <div class="form-group"><label>TMDB মুভি ID</label><input type="text" id="tmdbMovieId" class="form-input" placeholder="যেমন: 603"></div>
                    <button id="fetchMovieFromTmdbBtn" class="btn btn-primary">তথ্য আনুন</button>
                </div>
                <div class="form-section">
                    <h3 class="form-title" id="movieFormTitle">নতুন মুভি যোগ করুন</h3>
                    <form id="movieForm">
                        <input type="hidden" id="movieKey">
                        <div class="form-group"><label>মুভির শিরোনাম</label><input type="text" id="movieTitle" class="form-input" required></div>
                        <div class="form-group"><label>বর্ণনা</label><textarea id="movieDescription" class="form-textarea" required></textarea></div>
                        <div class="form-group"><label>রেটিং</label><input type="number" id="movieRating" class="form-input" step="0.1" required></div>
                        <div class="form-group">
                            <label>ধরন (Type)</label>
                            <select id="movieType" class="form-select" required>
                                <option value="free">ফ্রি</option>
                                <option value="premium">প্রিমিয়াম</option>
                            </select>
                        </div>
                        <div class="form-group"><label>থাম্বনেইল URL</label><input type="url" id="movieThumbnail" class="form-input" required></div>
                        <div class="form-group"><label>ব্যানার URL</label><input type="url" id="movieBanner" class="form-input"></div>
                        <div class="form-group"><label>ভিডিও URL</label><input type="url" id="movieVideo" class="form-input" required></div>
                        <div class="form-group"><label>ডাউনলোড URL</label><input type="url" id="movieDownload" class="form-input"></div>
                        <button type="submit" class="btn btn-primary" id="movieSubmitBtn">সংরক্ষণ করুন</button>
                        <button type="button" class="btn btn-secondary" id="movieCancelBtn" style="display:none;">বাতিল</button>
                    </form>
                </div>
                <div class="form-section">
                    <h3 class="form-title">সংরক্ষিত মুভি</h3>
                    <table class="data-table">
                        <thead><tr><th>থাম্বনেইল</th><th>শিরোনাম</th><th>কর্ম</th></tr></thead>
                        <tbody id="moviesTable"></tbody>
                    </table>
                </div>
            </section>
            
            <section id="seriesManagementSection" style="display: none;">
                 <div class="form-section">
                    <h3 class="form-title">TMDB থেকে তথ্য আনুন</h3>
                    <div class="form-group"><label>TMDB সিরিজ ID</label><input type="text" id="tmdbSeriesId" class="form-input" placeholder="যেমন: 1399"></div>
                    <button id="fetchSeriesFromTmdbBtn" class="btn btn-primary">তথ্য আনুন</button>
                </div>
                 <div class="form-section">
                    <h3 class="form-title">নতুন সিরিজ যোগ করুন</h3>
                    <form id="seriesForm">
                        <div class="form-group"><label>সিরিজের শিরোনাম</label><input type="text" id="seriesTitle" class="form-input" required></div>
                        <div class="form-group"><label>বর্ণনা</label><textarea id="seriesDescription" class="form-textarea" required></textarea></div>
                        <div class="form-group">
                            <label>ধরন (Type)</label>
                            <select id="seriesType" class="form-select" required>
                                <option value="free">ফ্রি</option>
                                <option value="premium">প্রিমিয়াম</option>
                            </select>
                        </div>
                        <div class="form-group"><label>থাম্বনেইল URL</label><input type="url" id="seriesThumbnail" class="form-input" required></div>
                        <div class="form-group"><label>ব্যানার URL</label><input type="url" id="seriesBanner" class="form-input"></div>
                        <button type="submit" class="btn btn-primary">সিরিজ সংরক্ষণ করুন</button>
                    </form>
                </div>
                <div class="form-section">
                    <h3 class="form-title">সংরক্ষিত সিরিজ</h3>
                    <table class="data-table">
                        <thead><tr><th>থাম্বনেইল</th><th>শিরোনাম</th><th>কর্ম</th></tr></thead>
                        <tbody id="seriesTable"></tbody>
                    </table>
                </div>
            </section>

            <section id="episodeManagementSection" style="display: none;">
                <div class="episode-management-header">
                    <i id="backToSeriesBtn" class="fas fa-arrow-left"></i>
                    <h2 id="seriesEpisodesTitle"></h2>
                </div>
                <div class="form-section">
                    <h3 class="form-title">TMDB থেকে তথ্য আনুন</h3>
                    <p style="margin-bottom:10px; font-size:14px; color:#666;">সিরিজের TMDB ID দিন এবং সকল সিজন ও এপিসোডের তথ্য স্বয়ংক্রিয়ভাবে যোগ করুন। এটি বিদ্যমান সিজন ডেটা মুছে ফেলবে।</p>
                    <div class="form-group"><label>TMDB সিরিজ ID</label><input type="text" id="tmdbSeriesIdForEpisodes" class="form-input" placeholder="যেমন: 1399"></div>
                    <button id="fetchEpisodesFromTmdbBtn" class="btn btn-primary">তথ্য আনুন</button>
                </div>
                <div class="form-section">
                    <h3 class="form-title">ম্যানুয়ালি নতুন সিজন যোগ করুন</h3>
                    <form id="addSeasonForm">
                        <div class="form-group"><label>সিজনের নাম (যেমন: সিজন ১)</label><input type="text" id="seasonTitle" class="form-input" required></div>
                        <button type="submit" class="btn btn-primary">সিজন যোগ করুন</button>
                    </form>
                </div>
                <div id="seasonsContainer"></div>
            </section>

            <!-- Other hidden sections -->
            <section id="subscriptionSection" style="display: none;">
                <h2 class="form-title">সাবস্ক্রিপশন ম্যানেজমেন্ট</h2>
                <div class="form-section">
                    <h3 class="form-title">নতুন প্ল্যান যোগ করুন</h3>
                    <form id="subscriptionForm">
                        <div class="form-group"><label>প্ল্যানের নাম</label><input type="text" id="planName" class="form-input" required></div>
                        <div class="form-group"><label>মূল্য (টাকায়)</label><input type="number" id="planPrice" class="form-input" required></div>
                        <div class="form-group"><label>সময়কাল (দিন)</label><input type="number" id="planDuration" class="form-input" required></div>
                        <button type="submit" class="btn btn-primary">প্ল্যান সংরক্ষণ</button>
                    </form>
                </div>
                <div class="form-section">
                    <h3 class="form-title">বিদ্যমান প্ল্যান</h3>
                    <table class="data-table">
                        <thead><tr><th>প্ল্যানের নাম</th><th>মূল্য</th><th>সময়কাল</th><th>কর্ম</th></tr></thead>
                        <tbody id="plansTable"></tbody>
                    </table>
                </div>
            </section>
            
            <section id="adManagementSection" style="display: none;">
                 <h2 class="form-title">বিজ্ঞাপন ম্যানেজমেন্ট</h2>
                 <div class="form-section">
                    <h3 class="form-title">Monetag বিজ্ঞাপন সেটিংস</h3>
                    <form id="monetagSettingsForm">
                        <div class="form-group"><label>Interstitial Ad VAST Tag</label><textarea id="monetagInterstitial" class="form-textarea" placeholder="ভিডিওর আগে দেখানো বিজ্ঞাপনের VAST ট্যাগ"></textarea></div>
                        <div class="form-group"><label>Homepage Banner Ad Code</label><textarea id="monetagHomeBanner" class="form-textarea" placeholder="হোমপেজের জন্য ব্যানার বিজ্ঞাপনের কোড"></textarea></div>
                        <div class="form-group"><label>Menu Banner Ad Code</label><textarea id="monetagMenuBanner" class="form-textarea" placeholder="অন্যান্য পেজের জন্য ব্যানার বিজ্ঞাপনের কোড"></textarea></div>
                        <button type="submit" class="btn btn-primary">বিজ্ঞাপন সেটিংস সংরক্ষণ</button>
                    </form>
                </div>
            </section>

            <section id="settingsSection" style="display: none;">
                <h2>সিস্টেম সেটিংস</h2>
                <div class="form-section">
                    <h3 class="form-title">API সেটিংস</h3>
                    <form id="apiSettingsForm">
                        <div class="form-group"><label>TMDB API কী</label><input type="text" id="tmdbApiKey" class="form-input"></div>
                        <button type="submit" class="btn btn-primary">সেটিংস সংরক্ষণ</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Episode Edit Modal -->
    <div id="editEpisodeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h3 class="form-title">এপিসোড এডিট করুন</h3>
            <form id="editEpisodeForm">
                <input type="hidden" id="editEpisodeKey">
                <div class="form-group"><label>এপিসোড শিরোনাম</label><input type="text" id="editEpisodeTitle" class="form-input" required></div>
                <div class="form-group"><label>ভিডিও URL</label><input type="url" id="editVideoUrl" class="form-input"></div>
                <div class="form-group"><label>ডাউনলোড URL</label><input type="url" id="editDownloadUrl" class="form-input"></div>
                <button type="submit" class="btn btn-primary">আপডেট করুন</button>
            </form>
        </div>
    </div>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAHmkJZuHL7Pq-KzWGQxfj6ih3UPouPKiY",
          authDomain: "hd-film-17c7f.firebaseapp.com",
          databaseURL: "https://hd-film-17c7f-default-rtdb.firebaseio.com",
          projectId: "hd-film-17c7f",
          storageBucket: "hd-film-17c7f.appspot.com",
          messagingSenderId: "583770082263",
          appId: "1:583770082263:web:51040c907693012b275992"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const ADMIN_UIDS = ["iN4vn8hPXtfJqdALGkPK9h4CmVj1"];
        let currentSeriesKey = null;
        let currentSeasonKey = null;

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => user ? checkAdminStatus(user.uid) : (window.location.href = 'login.html'));
            setupEventListeners();
        });

        function checkAdminStatus(uid) {
            if (ADMIN_UIDS.includes(uid)) {
                initializePanel();
                return;
            }
            database.ref(`users/${uid}/isAdmin`).once('value', s => {
                if (s.val()) initializePanel();
                else { alert('আপনার অ্যাডমিন এক্সেস নেই।'); window.location.href = 'index.html'; }
            });
        }
        
        function initializePanel() {
            loadDashboardData(); loadMovies(); loadSeries(); loadSettings(); loadSubscriptionPlans();
        }

        function setupEventListeners() {
            document.querySelectorAll('.menu-item').forEach(item => item.addEventListener('click', () => {
                document.querySelector('.menu-item.active').classList.remove('active');
                item.classList.add('active');
                document.querySelectorAll('.admin-main > section').forEach(s => s.style.display = 'none');
                document.getElementById(item.dataset.target).style.display = 'block';
            }));
            document.getElementById('movieForm').addEventListener('submit', saveMovie);
            document.getElementById('movieCancelBtn').addEventListener('click', resetMovieForm);
            document.getElementById('seriesForm').addEventListener('submit', saveSeries);
            document.getElementById('subscriptionForm').addEventListener('submit', saveSubscriptionPlan);
            document.getElementById('addSeasonForm').addEventListener('submit', addSeason);
            document.getElementById('fetchMovieFromTmdbBtn').addEventListener('click', fetchMovieFromTMDB);
            document.getElementById('fetchSeriesFromTmdbBtn').addEventListener('click', fetchSeriesFromTMDB);
            document.getElementById('fetchEpisodesFromTmdbBtn').addEventListener('click', fetchSeasonsFromTMDB);
            document.getElementById('apiSettingsForm').addEventListener('submit', saveApiSettings);
            document.getElementById('monetagSettingsForm').addEventListener('submit', saveMonetagSettings);
            document.getElementById('editEpisodeForm').addEventListener('submit', saveEpisodeChanges);
            document.getElementById('backToUser').addEventListener('click', () => window.location.href = 'index.html');
            document.getElementById('adminLogout').addEventListener('click', () => auth.signOut());
            document.getElementById('backToSeriesBtn').addEventListener('click', () => {
                document.getElementById('episodeManagementSection').style.display = 'none';
                document.getElementById('seriesManagementSection').style.display = 'block';
                currentSeriesKey = null;
            });
            document.getElementById('closeModalBtn').onclick = () => document.getElementById('editEpisodeModal').style.display = 'none';
        }

        function loadDashboardData() {
            database.ref('users').on('value', s => document.getElementById('totalUsers').textContent = s.numChildren());
            database.ref('movies').on('value', s => document.getElementById('totalMovies').textContent = s.numChildren());
            database.ref('series').on('value', s => document.getElementById('totalSeries').textContent = s.numChildren());
            database.ref('users').on('value', s => {
                let activeSubs = 0;
                s.forEach(c => c.val().subscription && new Date(c.val().subscription.expiryDate) > new Date() && activeSubs++);
                document.getElementById('activeSubscriptions').textContent = activeSubs;
            });
            database.ref('activityLogs').limitToLast(5).on('value', s => {
                const table = document.getElementById('activityTable');
                table.innerHTML = '';
                s.forEach(log => {
                    const d = log.val();
                    table.insertAdjacentHTML('afterbegin', `<tr><td>${new Date(d.timestamp).toLocaleString()}</td><td>${d.title}</td><td>${d.action}</td></tr>`);
                });
            });
        }
        
        function logActivity(action, title) { database.ref('activityLogs').push({ action, title, timestamp: Date.now() }); }

        async function fetchMovieFromTMDB() {
            const tmdbId = document.getElementById('tmdbMovieId').value;
            if (!tmdbId) { alert('অনুগ্রহ করে একটি TMDB মুভি ID দিন।'); return; }
            this.textContent = 'লোড হচ্ছে...'; this.disabled = true;
            try {
                const apiKey = (await database.ref('settings/tmdbApiKey').once('value')).val();
                if (!apiKey) throw new Error('TMDB API কী সেট করা নেই।');
                const res = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${apiKey}&language=bn-BD`);
                const data = await res.json();
                if (data.success === false) throw new Error(data.status_message);
                document.getElementById('movieTitle').value = data.title || '';
                document.getElementById('movieDescription').value = data.overview || '';
                document.getElementById('movieRating').value = data.vote_average || 0;
                document.getElementById('movieThumbnail').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
                document.getElementById('movieBanner').value = data.backdrop_path ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}` : '';
                alert('তথ্য সফলভাবে আনা হয়েছে!');
            } catch (error) { alert(`একটি ত্রুটি হয়েছে: ${error.message}`); } finally { this.textContent = 'তথ্য আনুন'; this.disabled = false; }
        }

        async function fetchSeriesFromTMDB() {
            const tmdbId = document.getElementById('tmdbSeriesId').value;
            if (!tmdbId) { alert('অনুগ্রহ করে একটি TMDB সিরিজ ID দিন।'); return; }
            this.textContent = 'লোড হচ্ছে...'; this.disabled = true;
            try {
                const apiKey = (await database.ref('settings/tmdbApiKey').once('value')).val();
                if (!apiKey) throw new Error('TMDB API কী সেট করা নেই।');
                const res = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${apiKey}&language=bn-BD`);
                const data = await res.json();
                if (data.success === false) throw new Error(data.status_message);
                document.getElementById('seriesTitle').value = data.name || '';
                document.getElementById('seriesDescription').value = data.overview || '';
                document.getElementById('seriesThumbnail').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
                document.getElementById('seriesBanner').value = data.backdrop_path ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}` : '';
                alert('তথ্য সফলভাবে আনা হয়েছে!');
            } catch (error) { alert(`একটি ত্রুটি হয়েছে: ${error.message}`); } finally { this.textContent = 'তথ্য আনুন'; this.disabled = false; }
        }

        function saveMovie(e) {
            e.preventDefault();
            const key = document.getElementById('movieKey').value;
            const movieData = {
                title: document.getElementById('movieTitle').value, description: document.getElementById('movieDescription').value,
                rating: parseFloat(document.getElementById('movieRating').value), thumbnail: document.getElementById('movieThumbnail').value,
                banner: document.getElementById('movieBanner').value, videoUrl: document.getElementById('movieVideo').value,
                downloadUrl: document.getElementById('movieDownload').value, type: document.getElementById('movieType').value,
            };
            const action = key ? 'আপডেট' : 'যোগ';
            const ref = key ? database.ref('movies/' + key) : database.ref('movies').push();
            ref.set(movieData).then(() => {
                alert(`মুভি সফলভাবে ${action} করা হয়েছে!`);
                logActivity(`মুভি ${action}`, movieData.title);
                resetMovieForm();
            });
        }

        function loadMovies() {
            database.ref('movies').on('value', s => {
                const table = document.getElementById('moviesTable');
                table.innerHTML = '';
                s.forEach(cs => {
                    const key = cs.key, data = cs.val();
                    table.innerHTML += `<tr>
                        <td><img src="${data.thumbnail}" width="50" height="70" style="object-fit:cover;"></td><td>${data.title}</td>
                        <td><button class="action-btn edit-btn" onclick="editMovie('${key}')">এডিট</button><button class="action-btn delete-btn" onclick="deleteContent('movies', '${key}')">ডিলিট</button></td>
                    </tr>`;
                });
            });
        }

        function editMovie(key) {
            database.ref('movies/' + key).once('value', s => {
                const d = s.val();
                document.getElementById('movieKey').value = key;
                document.getElementById('movieTitle').value = d.title;
                document.getElementById('movieDescription').value = d.description;
                document.getElementById('movieRating').value = d.rating;
                document.getElementById('movieType').value = d.type || 'free';
                document.getElementById('movieThumbnail').value = d.thumbnail;
                document.getElementById('movieBanner').value = d.banner;
                document.getElementById('movieVideo').value = d.videoUrl;
                document.getElementById('movieDownload').value = d.downloadUrl || '';
                document.getElementById('movieFormTitle').textContent = 'মুভি এডিট করুন';
                document.getElementById('movieSubmitBtn').textContent = 'আপডেট করুন';
                document.getElementById('movieCancelBtn').style.display = 'inline-block';
                window.scrollTo(0, 0);
            });
        }

        function resetMovieForm() {
            document.getElementById('movieForm').reset();
            document.getElementById('movieKey').value = '';
            document.getElementById('movieFormTitle').textContent = 'নতুন মুভি যোগ করুন';
            document.getElementById('movieSubmitBtn').textContent = 'সংরক্ষণ করুন';
            document.getElementById('movieCancelBtn').style.display = 'none';
        }

        function saveSeries(e) {
            e.preventDefault();
            const seriesData = {
                title: document.getElementById('seriesTitle').value, description: document.getElementById('seriesDescription').value,
                thumbnail: document.getElementById('seriesThumbnail').value, banner: document.getElementById('seriesBanner').value,
                type: document.getElementById('seriesType').value,
            };
            database.ref('series').push(seriesData).then(() => {
                alert('সিরিজ সফলভাবে যোগ করা হয়েছে!');
                logActivity('নতুন সিরিজ যোগ', seriesData.title);
                document.getElementById('seriesForm').reset();
            });
        }

        function loadSeries() {
            database.ref('series').on('value', s => {
                const table = document.getElementById('seriesTable');
                table.innerHTML = '';
                s.forEach(cs => {
                    const key = cs.key, data = cs.val();
                    table.innerHTML += `<tr>
                        <td><img src="${data.thumbnail}" width="50" height="70" style="object-fit:cover;"></td><td>${data.title}</td>
                        <td><button class="action-btn manage-btn" onclick="manageEpisodes('${key}')">এপিসোড</button><button class="action-btn delete-btn" onclick="deleteContent('series', '${key}')">ডিলিট</button></td>
                    </tr>`;
                });
            });
        }

        async function fetchSeasonsFromTMDB() {
            const tmdbId = document.getElementById('tmdbSeriesIdForEpisodes').value;
            if (!tmdbId) { alert('অনুগ্রহ করে একটি TMDB সিরিজ ID দিন।'); return; }
            this.textContent = 'লোড হচ্ছে...'; this.disabled = true;

            try {
                const apiKey = (await database.ref('settings/tmdbApiKey').once('value')).val();
                if (!apiKey) { throw new Error('TMDB API কী সেট করা নেই।'); }
                const seriesRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${apiKey}`);
                const seriesData = await seriesRes.json();
                
                let seasonsData = {};
                for (let i = 1; i <= seriesData.number_of_seasons; i++) {
                    const seasonRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${i}?api_key=${apiKey}`);
                    const seasonDetails = await seasonRes.json();
                    
                    let episodes = {};
                    seasonDetails.episodes.forEach(ep => {
                        episodes[`episode_${ep.episode_number}`] = {
                            title: `E${ep.episode_number}: ${ep.name}`, description: ep.overview,
                            thumbnail: ep.still_path ? `https://image.tmdb.org/t/p/w500${ep.still_path}` : '',
                            videoUrl: '', downloadUrl: ''
                        };
                    });
                    seasonsData[`season_${i}`] = { title: seasonDetails.name, episodes };
                }
                
                await database.ref(`series/${currentSeriesKey}/seasons`).set(seasonsData);
                alert('সকল সিজন এবং এপিসোড সফলভাবে যোগ করা হয়েছে!');
                logActivity('TMDB থেকে এপিসোড যোগ', seriesData.name);
            } catch (error) { alert(`একটি ত্রুটি হয়েছে: ${error.message}`); } 
            finally { this.textContent = 'তথ্য আনুন'; this.disabled = false; }
        }

        function manageEpisodes(key) {
            currentSeriesKey = key;
            document.getElementById('seriesManagementSection').style.display = 'none';
            document.getElementById('episodeManagementSection').style.display = 'block';
            database.ref('series/' + key).once('value', s => {
                document.getElementById('seriesEpisodesTitle').textContent = `"${s.val().title}" এর এপিসোড`;
            });
            loadSeasonsAndEpisodes(key);
        }

        function addSeason(e) {
            e.preventDefault();
            const title = document.getElementById('seasonTitle').value;
            database.ref(`series/${currentSeriesKey}/seasons`).push({ title }).then(() => {
                alert('সিজন যোগ করা হয়েছে!'); e.target.reset();
            });
        }
        
        function loadSeasonsAndEpisodes(seriesKey) {
            database.ref(`series/${seriesKey}/seasons`).on('value', s => {
                const container = document.getElementById('seasonsContainer');
                container.innerHTML = '';
                s.forEach(ss => {
                    const seasonKey = ss.key, seasonData = ss.val();
                    const seasonHtml = `<div class="form-section season-container">
                        <h3 class="form-title">${seasonData.title}</h3><div id="episodes-${seasonKey}"></div>
                        <form onsubmit="addEpisode(event, '${seriesKey}', '${seasonKey}')">
                            <h4>নতুন এপিসোড যোগ করুন</h4>
                            <div class="form-group"><label>শিরোনাম</label><input type="text" class="form-input" required></div>
                            <div class="form-group"><label>ভিডিও URL</label><input type="url" class="form-input" required></div>
                            <div class="form-group"><label>ডাউনলোড URL</label><input type="url" class="form-input"></div>
                            <button type="submit" class="btn btn-primary">যোগ করুন</button>
                        </form></div>`;
                    container.innerHTML += seasonHtml;

                    if (seasonData.episodes) {
                        const epContainer = document.getElementById(`episodes-${seasonKey}`);
                        Object.entries(seasonData.episodes).forEach(([epKey, epData]) => {
                            epContainer.innerHTML += `<div class="episode-card" id="ep-${epKey}"><span>${epData.title}</span>
                                <div><button class="action-btn edit-btn" onclick="openEditEpisodeModal('${seriesKey}', '${seasonKey}', '${epKey}')">এডিট</button>
                                <button class="action-btn delete-btn" onclick="deleteEpisode('${seriesKey}', '${seasonKey}', '${epKey}')">ডিলিট</button></div></div>`;
                        });
                    }
                });
            });
        }
        
        function addEpisode(e, seriesKey, seasonKey) {
            e.preventDefault();
            const form = e.target;
            const episodeData = { title: form.elements[0].value, videoUrl: form.elements[1].value, downloadUrl: form.elements[2].value };
            database.ref(`series/${seriesKey}/seasons/${seasonKey}/episodes`).push(episodeData).then(() => {
                alert('এপিসোড যোগ করা হয়েছে!'); form.reset();
            });
        }
        
        function openEditEpisodeModal(seriesKey, seasonKey, episodeKey) {
            currentSeasonKey = seasonKey;
            database.ref(`series/${seriesKey}/seasons/${seasonKey}/episodes/${episodeKey}`).once('value', s => {
                const data = s.val();
                document.getElementById('editEpisodeKey').value = episodeKey;
                document.getElementById('editEpisodeTitle').value = data.title;
                document.getElementById('editVideoUrl').value = data.videoUrl || '';
                document.getElementById('editDownloadUrl').value = data.downloadUrl || '';
                document.getElementById('editEpisodeModal').style.display = 'block';
            });
        }

        function saveEpisodeChanges(e) {
            e.preventDefault();
            const episodeKey = document.getElementById('editEpisodeKey').value;
            const updatedData = {
                title: document.getElementById('editEpisodeTitle').value,
                videoUrl: document.getElementById('editVideoUrl').value,
                downloadUrl: document.getElementById('editDownloadUrl').value
            };
            database.ref(`series/${currentSeriesKey}/seasons/${currentSeasonKey}/episodes/${episodeKey}`).update(updatedData)
                .then(() => {
                    alert('এপিসোড আপডেট করা হয়েছে!');
                    document.getElementById('editEpisodeModal').style.display = 'none';
                });
        }

        function deleteEpisode(seriesKey, seasonKey, episodeKey) {
             if (confirm('আপনি কি এই এপিসোডটি ডিলিট করতে চান?')) {
                database.ref(`series/${seriesKey}/seasons/${seasonKey}/episodes/${episodeKey}`).remove();
            }
        }
        
        function deleteContent(type, key) {
            if (confirm(`আপনি কি এই ${type === 'movies' ? 'মুভি' : 'সিরিজ'}টি ডিলিট করতে চান?`)) {
                database.ref(type + '/' + key).remove().then(() => alert('সফলভাবে ডিলিট করা হয়েছে!'));
            }
        }
        
        function saveApiSettings(e) {
            e.preventDefault();
            const apiKey = document.getElementById('tmdbApiKey').value;
            database.ref('settings').update({ tmdbApiKey: apiKey }).then(() => alert('API কী সংরক্ষণ করা হয়েছে!'));
        }

        function saveMonetagSettings(e) {
            e.preventDefault();
            const adSettings = {
                interstitial: document.getElementById('monetagInterstitial').value,
                homeBanner: document.getElementById('monetagHomeBanner').value,
                menuBanner: document.getElementById('monetagMenuBanner').value
            };
            database.ref('settings/monetagAds').update(adSettings).then(() => alert('বিজ্ঞাপন সেটিংস সংরক্ষণ করা হয়েছে!'));
        }

        function loadSettings() {
            database.ref('settings').once('value', s => {
                if(s.val()) {
                    document.getElementById('tmdbApiKey').value = s.val().tmdbApiKey || '';
                    if (s.val().monetagAds) {
                        document.getElementById('monetagInterstitial').value = s.val().monetagAds.interstitial || '';
                        document.getElementById('monetagHomeBanner').value = s.val().monetagAds.homeBanner || '';
                        document.getElementById('monetagMenuBanner').value = s.val().monetagAds.menuBanner || '';
                    }
                }
            });
        }
        
        function saveSubscriptionPlan(e) {
            e.preventDefault();
            const plan = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value),
                duration: parseInt(document.getElementById('planDuration').value),
            };
            database.ref('subscriptionPlans').push(plan).then(() => {
                alert('প্ল্যান যোগ করা হয়েছে!');
                e.target.reset();
            });
        }

        function loadSubscriptionPlans() {
            database.ref('subscriptionPlans').on('value', s => {
                const table = document.getElementById('plansTable');
                table.innerHTML = '';
                s.forEach(cs => {
                    const key = cs.key, data = cs.val();
                    table.innerHTML += `<tr><td>${data.name}</td><td>${data.price} টাকা</td><td>${data.duration} দিন</td>
                    <td><button class="action-btn delete-btn" onclick="deleteSubscriptionPlan('${key}')">ডিলিট</button></td></tr>`;
                });
            });
        }
        
        function deleteSubscriptionPlan(key) {
            if(confirm('আপনি কি এই প্ল্যানটি ডিলিট করতে চান?')) {
                database.ref('subscriptionPlans/' + key).remove();
            }
        }
    </script>
</body>
</html>
